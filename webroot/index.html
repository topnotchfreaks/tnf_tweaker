<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TNF Tweaker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex justify-center items-center p-4">
  <div class="w-[393px] bg-zinc-900 overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center px-6 pt-6">
      <h1 class="text-xl font-bold tracking-tight">TNF Tweaker</h1>
    </div>

    <!-- System Info Card -->
    <div class="bg-zinc-800 rounded-xl p-4 mx-6 mt-4 space-y-3 text-sm shadow-inner">
      <div class="flex items-center space-x-2">
        <img src="assets/cpu.svg" alt="Kernel" class="w-5 h-5" />
        <p>Kernel version<br><span id="kernel-version" class="text-gray-400">Loading...</span></p>
      </div>
      <div class="flex items-center space-x-2">
        <img src="assets/phone.svg" alt="Device" class="w-5 h-5" />
        <p>Device model<br><span id="device-model" class="text-gray-400">Loading...</span></p>
      </div>
      <div class="flex items-center space-x-2">
        <img src="assets/settings.svg" alt="Module" class="w-5 h-5" />
        <p>Module version<br><span id="module-version" class="text-gray-400">Loading...</span></p>
      </div>
      <div class="flex items-center space-x-2">
        <img src="assets/check.svg" alt="Status" class="w-5 h-5" />
        <p>Module Status<br><span id="module-status" class="text-gray-400">BETA</span></p>
      </div>
    </div>

    <!-- Kernel Profiles -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm">Kernel Profiles Mode</label>
      <div class="flex items-center">
        <div id="profile-icon-container" class="relative flex items-center space-x-2 bg-zinc-800 px-4 py-2 rounded-xl shadow flex-1">
          <img id="profile-icon" src="assets/settings.svg" alt="Profile" class="w-5 h-5 min-w-5 min-h-5 max-w-5 max-h-5 transition-all duration-200 object-contain" />
          <select id="profile-select" class="bg-transparent focus:outline-none text-white pr-8 w-full">
            <option value="powersave">Powersave</option>
            <option value="balanced">Balanced</option>
            <option value="performance">Performance</option>
          </select>
        </div>
        <button id="apply-profile" class="ml-4 bg-red-500 text-white px-6 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-transform whitespace-nowrap">
          Apply
        </button>
      </div>
    </div>

    <!-- Thermal Mode -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm">Thermal Throttling</label>
      <div class="flex justify-between items-center bg-zinc-800 px-4 py-3 rounded-xl shadow">
        <div class="flex items-center space-x-2">
          <img src="assets/heat.svg" alt="Thermal" class="w-5 h-5" />
          <span id="thermal-status">Enabled</span>
        </div>
        <!-- Toggle Switch -->
        <label class="relative inline-flex items-center cursor-pointer">
          <input id="thermal-toggle" type="checkbox" class="sr-only peer" checked>
          <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:bg-red-500 transition-colors"></div>
          <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>

    <!-- Bypass Charging -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm">Bypass Charging</label>
      <div class="flex justify-between items-center bg-zinc-800 px-4 py-3 rounded-xl shadow">
        <div class="flex items-center space-x-2">
          <img src="assets/charging.svg" alt="Bypass" class="w-5 h-5" />
          <span id="charging-status">Disabled</span>
        </div>
        <!-- Toggle Switch -->
        <label class="relative inline-flex items-center cursor-pointer">
          <input id="charging-toggle" type="checkbox" class="sr-only peer">
          <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:bg-red-500 transition-colors"></div>
          <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>

    <!-- About Modules -->
    <div class="px-6 mt-6 mb-8">
      <label class="block mb-2 font-semibold text-sm">About Modules</label>
      <div class="bg-zinc-800 rounded-xl px-4 py-3 flex items-center justify-between shadow">
        <div class="text-sm">
          <p>GitHub Project<br><span class="text-gray-400">TNF Tweaker</span></p>
          <p>Support group<br><span class="text-gray-400">t.me/topnotchfreaks_chat</span></p>
        </div>
        <div class="flex flex-col space-y-3 items-end ml-4">
          <a href="https://github.com/topnotchfreaks/tnf_tweaker" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors" title="GitHub">
            <img src="assets/github.svg" alt="Author" class="w-6 h-6 inline" style="filter: invert(1) brightness(2);" />
          </a>
          <a href="https://t.me/topnotchfreaks_chat" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors" title="Telegram">
            <img src="assets/telegram.svg" alt="Telegram" class="w-6 h-6 inline" style="filter: invert(1) brightness(2);" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-50 bg-zinc-800 text-white px-6 py-3 rounded-xl shadow-lg opacity-0 pointer-events-none transition-all duration-300"></div>

  <script>
    // filepath: /home/env/Documents/GitHub/tnf_tweaker/webroot/index.html
    // --- KernelSU JS API helpers ---
    let callbackCounter = 0;
    function getUniqueCallbackName(prefix) {
      return `${prefix}_callback_${Date.now()}_${callbackCounter++}`;
    }

    function exec(command, options) {
      if (typeof options === "undefined") options = {};
      return new Promise((resolve, reject) => {
        const callbackFuncName = getUniqueCallbackName("exec");
        window[callbackFuncName] = (errno, stdout, stderr) => {
          resolve({ errno, stdout, stderr });
          delete window[callbackFuncName];
        };
        try {
          ksu.exec(command, JSON.stringify(options), callbackFuncName);
        } catch (error) {
          reject(error);
          delete window[callbackFuncName];
        }
      });
    }

    async function updateTweakerConfig(key, value) {
    const path = "/data/adb/tnftweaker/tweaker_config.conf";

      try {
        const { stdout } = await exec(`cat ${path} || touch ${path} && echo ""`);
        const lines = stdout.split("\n").filter(Boolean);
        let updated = false;
      
        // Update line if key exists
        const newLines = lines.map(line => {
          if (line.startsWith(`${key}=`)) {
            updated = true;
            return `${key}=${value}`;
          }
          return line;
        });
      
        if (!updated) {
          newLines.push(`${key}=${value}`);
        }
      
        const newContent = newLines.join("\n");
      
        await exec(`echo "${newContent}" > ${path}`);
      } catch (err) {
        console.error("Failed to update tweaker_config.conf:", err);
      }
    }

    // Function to load the current kernel profile
    const profileSelect = document.getElementById('profileSelect');
    const profileIcon = document.getElementById('profileIcon');
    const icons = {
      powersave: 'icons/powersave.png',
      balanced: 'icons/balanced.png',
      performance: 'icons/performance.png',
    };

    async function loadCurrentProfile() {
      try {
        const { stdout } = await exec('cat /sys/kernel/kprofiles/kp_mode');
        const val = stdout.trim();
        const map = { '1': 'powersave', '2': 'balanced', '3': 'performance' };
        const profile = map[val] || 'balanced';
        profileSelect.value = profile;
        profileIcon.src = icons[profile];
      } catch (err) {
        console.error("Failed to read kernel profile:", err);
      }
    }

    // Function to set kernel profile mode
    function setKProfilesMode(mode) {
      // Map mode string to value
      let value = "3"; // Default to Performance
      if (mode === "powersave") value = "1";
      else if (mode === "balanced") value = "2";
      else if (mode === "performance") value = "3";
      // Execute the shell command
      return exec(`echo ${value} > /sys/kernel/kprofiles/kp_mode`);
    }

    // --- UI logic ---
    document.addEventListener('DOMContentLoaded', async () => {
      fetchDeviceInfo(); // Start fetching device info immediately

      await loadTweakerConfig();

      // Profile icon logic
      const profileSelect = document.getElementById('profile-select');
      const profileIcon = document.getElementById('profile-icon');
      const applyProfileBtn = document.getElementById('apply-profile');
      const icons = {
        powersave: 'assets/powersave.svg',
        balanced: 'assets/balanced.svg',
        performance: 'assets/performance.svg'
      };

      if (applyProfileBtn && profileSelect) {
        applyProfileBtn.addEventListener('click', () => {
          const selectedText = profileSelect.options[profileSelect.selectedIndex].text;
          setKProfilesMode(profileSelect.value)
            .then(() => {
              showToast(`Applied profile: ${selectedText}`);
              // Save the selected profile persistently for boot
              exec(`echo "profile=${profileSelect.value}" > /data/adb/tnftweaker/tweaker_config.conf`);
            })
            .catch(() => showToast('Failed to apply profile'));
        });
      }

      // Remove this block to prevent auto-applying on select change:
      if (profileSelect && profileIcon) {
        profileSelect.addEventListener('change', (e) => {
          profileIcon.src = icons[e.target.value] || icons.balanced;
          showToast(`Profile set to ${e.target.options[e.target.selectedIndex].text}`);
        });
        profileIcon.src = icons[profileSelect.value] || icons.balanced;
      }

      // Toast for toggles
      document.querySelectorAll('input[type="checkbox"]').forEach(toggle => {
        // Skip bypass toggle and thermal toggle (handled separately)
        if (toggle.id === 'bypass-toggle' || toggle.id === 'thermal-toggle') return;
        toggle.addEventListener('change', (e) => {
          const label = e.target.closest('.flex.items-center.space-x-2')?.innerText ||
                        e.target.closest('.flex.items-center')?.innerText ||
                        'Setting';
          showToast(`${label.trim()} ${e.target.checked ? 'enabled' : 'disabled'}`);
        });
        // Skip bypass toggle and charging toggle (handled separately)
        if (toggle.id === 'bypass-toggle' || toggle.id === 'charging-toggle') return;
        toggle.addEventListener('change', (e) => {
          const label = e.target.closest('.flex.items-center.space-x-2')?.innerText ||
                        e.target.closest('.flex.items-center')?.innerText ||
                        'Setting';
          showToast(`${label.trim()} ${e.target.checked ? 'enabled' : 'disabled'}`);
        });
      });

      // Refresh button notification
      const refreshBtn = document.getElementById('refresh-btn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          showToast('Refreshed!');
          fetchDeviceInfo();
          fetchModuleVersion();
        });
      }

    // Load current profile on page load
    document.addEventListener("DOMContentLoaded", () => {
      profileSelect.addEventListener("change", async () => {
        const selected = profileSelect.value;
        await setKProfilesMode(selected);
        await updateTweakerConfig("profile", selected);
      });
    
      loadCurrentProfile(); // This alone is enough
    });

      // Thermal toggle logic
      const thermalToggle = document.getElementById('thermal-toggle');
      const thermalStatus = document.getElementById('thermal-status');
        
      if (thermalToggle && thermalStatus) {
        thermalToggle.addEventListener('change', async (e) => {
          const enabled = e.target.checked;
          const result = await setThermalThrottling(enabled);
        
          thermalStatus.textContent = result ? (enabled ? 'Enabled' : 'Disabled') : 'Failed';
          showToast(`Thermal Throttling ${result ? (enabled ? 'enabled' : 'disabled') : 'failed'}`);
        
          await updateTweakerConfig("thermal", enabled ? "enabled" : "disabled");
        });
      }

      // Bypass Charging toggle logic
      const chargingToggle = document.getElementById('charging-toggle');
      const chargingStatus = document.getElementById('charging-status');
        
      if (chargingToggle && chargingStatus) {
        chargingToggle.addEventListener('change', async (e) => {
          const enabled = e.target.checked;
          const result = await setBypassCharging(enabled);
        
          chargingStatus.textContent = result ? (enabled ? 'Enabled' : 'Disabled') : 'Failed';
          showToast(`Bypass charging ${result ? (enabled ? 'enabled' : 'disabled') : 'failed'}`);
        
        });
      }

      // Initial fetches
      fetchDeviceInfo();
      fetchModuleVersion();
    });

    // Toast notification function
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('opacity-0', 'pointer-events-none');
      toast.classList.add('opacity-100');
      clearTimeout(window._toastTimeout);
      window._toastTimeout = setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0', 'pointer-events-none');
      }, 2000);
    }

    // Fetch kernel version and device model using KernelSU exec
    function fetchDeviceInfo() {
      // Start both fetches at the same time
      exec('uname -r').then(({ stdout }) => {
        document.getElementById('kernel-version').textContent = stdout.trim() || 'Unknown';
      }).catch(() => {
        document.getElementById('kernel-version').textContent = 'Error loading';
      });

      exec('getprop ro.product.vendor.model').then(({ stdout }) => {
        document.getElementById('device-model').textContent = stdout.trim() || 'Unknown';
      }).catch(() => {
        document.getElementById('device-model').textContent = 'Error loading';
      });
    }

    // Fetch module version from GitHub releases (still uses fetch, not exec)
    function fetchModuleVersion() {
      fetch('https://api.github.com/repos/topnotchfreaks/tnf_tweaker/releases/latest')
        .then(res => res.json())
        .then (data => {
          document.getElementById('module-version').textContent = data.tag_name || 'Unknown';
        })
        .catch(() => {
          document.getElementById('module-version').textContent = 'Unavailable';
        });
    }

    // Set thermal throttling state using KernelSU exec
    async function setThermalThrottling(enable) {
      try {
        let commands = [];
        if (enable) {
          // Enable thermal throttling
          commands = [
            `echo enabled > /sys/class/thermal/thermal_zone*/mode`,
            `echo 1 > /sys/kernel/sched_boost`,
            `echo Y > /sys/module/msm_thermal/parameters/enabled`,
            `echo 1 > /sys/module/msm_thermal/core_control/enabled`,
            `echo 1 > /sys/kernel/msm_thermal/enabled`,
            `setprop init.svc.thermal running`,
            `setprop init.svc.thermal-managers running`,
            `setprop init.svc.thermal_manager running`,
            `setprop init.svc.thermal_mnt_hal_service running`,
            `setprop init.svc.thermal-engine running`,
            `setprop init.svc.mi-thermald running`,
            `setprop init.svc.mi_thermald running`,
            `setprop init.svc.thermalloadalgod running`,
            `setprop init.svc.thermalservice running`,
            `setprop init.svc.thermal-hal running`,
            `setprop init.svc.vendor.thermal-symlinks running`,
            `setprop init.svc.android.thermal-hal running`,
            `setprop init.svc.vendor.thermal-hal running`,
            `setprop init.svc.thermal-manager running`,
            `setprop init.svc.vendor-thermal-hal-1-0 running`,
            `setprop init.svc.vendor.thermal-hal-1-0 running`,
            `setprop init.svc.vendor.thermal-hal-2-0 running`
          ];
        } else {
          // Disable thermal throttling
          commands = [
            `echo 0 > /sys/class/thermal/thermal_zone*/mode`,
            `echo 0 > /sys/kernel/sched_boost`,
            `echo N > /sys/module/msm_thermal/parameters/enabled`,
            `echo 0 > /sys/module/msm_thermal/core_control/enabled`,
            `echo 0 > /sys/kernel/msm_thermal/enabled`,
            `setprop init.svc.thermal stopped`,
            `setprop init.svc.thermal-managers stopped`,
            `setprop init.svc.thermal_manager stopped`,
            `setprop init.svc.thermal_mnt_hal_service stopped`,
            `setprop init.svc.thermal-engine stopped`,
            `setprop init.svc.mi-thermald stopped`,
            `setprop init.svc.mi_thermald stopped`,
            `setprop init.svc.thermalloadalgod stopped`,
            `setprop init.svc.thermalservice stopped`,
            `setprop init.svc.thermal-hal stopped`,
            `setprop init.svc.vendor.thermal-symlinks stopped`,
            `setprop init.svc.android.thermal-hal stopped`,
            `setprop init.svc.vendor.thermal-hal stopped`,
            `setprop init.svc.thermal-manager stopped`,
            `setprop init.svc.vendor-thermal-hal-1-0 stopped`,
            `setprop init.svc.vendor.thermal-hal-1-0 stopped`,
            `setprop init.svc.vendor.thermal-hal-2-0 stopped`
          ];
        }
        // Run all commands sequentially
        for (const cmd of commands) {
          await exec(cmd);
        }
        return true;
      } catch {
        return false;
      }
    }

    // Set bypass charging state using KernelSU exec
    async function setBypassCharging(enable) {
      try {
        let commands = [];
        if (enable) {
          commands = [
            `echo 1 > /sys/class/qcom-battery/input_suspend`
          ];
        } else {
          commands = [
            `echo 0 > /sys/class/qcom-battery/input_suspend`
          ];
        }
        for (const cmd of commands) {
          await exec(cmd);
        }
        return true;
      } catch {
        return false;
      }
    }

    async function loadTweakerConfig() {
      const path = "/data/adb/tnftweaker/tweaker_config.conf";
      try {
        const { stdout } = await exec(`cat ${path} || echo ""`);
        const lines = stdout.split("\n").filter(Boolean);
        let profile = "balanced";
        let thermal = "enabled";

        lines.forEach(line => {
          if (line.startsWith("profile=")) profile = line.split("=")[1];
          if (line.startsWith("thermal=")) thermal = line.split("=")[1];
          // bypasscharging= is ignored
        });

        // Set kernel profile select and icon
        const profileSelect = document.getElementById('profile-select');
        const profileIcon = document.getElementById('profile-icon');
        if (profileSelect) {
          profileSelect.value = profile;
          if (profileIcon) {
            const icons = {
              powersave: 'assets/powersave.svg',
              balanced: 'assets/balanced.svg',
              performance: 'assets/performance.svg'
            };
            profileIcon.src = icons[profile] || icons.balanced;
          }
          // Apply the profile to the system
          await setKProfilesMode(profile);
        }

        // Set thermal toggle and status
        const thermalToggle = document.getElementById('thermal-toggle');
        const thermalStatus = document.getElementById('thermal-status');
        if (thermalToggle && thermalStatus) {
          thermalToggle.checked = (thermal === "enabled");
          await setThermalThrottling(thermal === "enabled");
          thermalStatus.textContent = (thermal === "enabled") ? "Enabled" : "Disabled";
        }

        // Set bypass charging toggle and status
        const chargingToggle = document.getElementById('charging-toggle');
        const chargingStatus = document.getElementById('charging-status');
        if (chargingToggle && chargingStatus) {
          chargingToggle.checked = (bypasscharging === "enabled");
          await setBypassCharging(bypasscharging === "enabled");
          chargingStatus.textContent = (bypasscharging === "enabled") ? "Enabled" : "Disabled";
        }
      } catch (err) {
        console.error("Failed to load tweaker_config.conf:", err);
      }
    }

    loadTweakerConfig();
  </script>
</body>
</html>
