<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TNF Tweaker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex justify-center items-center p-4">
  <div class="w-[393px] bg-zinc-900 overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center px-6 pt-6">
      <h1 class="text-xl font-bold tracking-tight">TNF Tweaker</h1>
      <select id="lang-select" class="bg-zinc-800 text-white rounded px-2 py-1 ml-4">
        <option value="en">EN</option>
        <option value="id">ID</option>
        <option value="es">ES</option>
        <option value="pt">PT</option>
        <option value="zh">CN</option>
        <option value="ja">JP</option>
        <option value="kr">KR</option>
        <!-- Add more languages as needed -->
      </select>
    </div>

    <!-- System Info Card -->
    <div class="bg-zinc-800 rounded-xl p-4 mx-6 mt-4 space-y-3 text-sm shadow-inner">
      <div class="flex items-center space-x-2">
        <img src="assets/cpu.svg" alt="Kernel" class="w-5 h-5" />
        <p><span data-i18n="kernel_version">Kernel version</span><br><span id="kernel-version" class="text-gray-400">Loading...</span></p>
      </div>
      <div class="flex items-center space-x-2">
        <img src="assets/phone.svg" alt="Device" class="w-5 h-5" />
        <p><span data-i18n="device_model">Device model</span><br><span id="device-model" class="text-gray-400">Loading...</span></p>
      </div>
      <div class="flex items-center space-x-2">
        <img src="assets/settings.svg" alt="Module" class="w-5 h-5" />
        <p><span data-i18n="module_version">Module version</span><br><span id="module-version" class="text-gray-400">Loading...</span></p>
      </div>
    </div>

    <!-- Simple Stats Cards -->
    <div class="flex justify-around mx-6 mt-2 space-x-3 text-xs text-gray-300">
      <div class="bg-zinc-800 rounded-md p-2 flex flex-col items-center w-20 shadow">
        <p class="text-gray-400">CPU</p>
        <span id="cpu-big-clock" class="font-mono">--MHz</span>
      </div>
      <div class="bg-zinc-800 rounded-md p-2 flex flex-col items-center w-20 shadow">
        <p class="text-gray-400">CPU</p>
        <span id="cpu-little-clock" class="font-mono">--MHz</span>
      </div>
      <div class="bg-zinc-800 rounded-md p-2 flex flex-col items-center w-20 shadow">
        <p class="text-gray-400">Battery</p>
        <span id="battery-temp" class="font-mono">--°C</span>
      </div>
      <div class="bg-zinc-800 rounded-md p-2 flex flex-col items-center w-20 shadow">
        <p class="text-gray-400">RAM</p>
        <span id="ram-util" class="font-mono">--%</span>
      </div>
    </div>

    <!-- Kernel Profiles -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm" data-i18n="kernel_profiles_mode">Kernel Profiles Mode</label>
      <div class="flex items-center">
        <div id="profile-icon-container" class="relative flex items-center space-x-2 bg-zinc-800 px-4 py-2 rounded-xl shadow flex-1">
          <img id="profile-icon" src="assets/settings.svg" alt="Profile" class="w-5 h-5 min-w-5 min-h-5 max-w-5 max-h-5 transition-all duration-200 object-contain" />
          <select id="profile-select" class="bg-transparent focus:outline-none text-white pr-8 w-full">
            <option value="powersave">Powersave</option>
            <option value="balanced">Balanced</option>
            <option value="performance">Performance</option>
          </select>
        </div>
        <button id="apply-profile" class="ml-4 bg-red-500 text-white px-6 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-transform whitespace-nowrap">
          Apply
        </button>
      </div>
    </div>

    <!-- CPU Governor Selector -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm" data-i18n="cpu_governor">CPU Governor</label>
      <div class="flex items-center">
        <div id="governor-icon-container" class="relative flex items-center space-x-2 bg-zinc-800 px-4 py-2 rounded-xl shadow flex-1">
          <img id="governor-icon" src="assets/settings.svg" alt="Governor" class="w-5 h-5 object-contain" />
          <select id="governor-select" class="bg-transparent focus:outline-none text-white pr-8 w-full">
            <option value="">Loading...</option>
          </select>
        </div>
        <button id="apply-governor" class="ml-4 bg-red-500 text-white px-6 py-2 rounded-xl font-semibold shadow hover:scale-105 transition-transform whitespace-nowrap">
          Apply
        </button>
      </div>
    </div>

    <!-- Thermal Mode -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm" data-i18n="thermal_throttling">Thermal Throttling</label>
      <div class="flex justify-between items-center bg-zinc-800 px-4 py-3 rounded-xl shadow">
        <div class="flex items-center space-x-2">
          <img src="assets/heat.svg" alt="Thermal" class="w-5 h-5" />
          <span id="thermal-status">Enabled</span>
        </div>
        <!-- Toggle Switch -->
        <label class="relative inline-flex items-center cursor-pointer">
          <input id="thermal-toggle" type="checkbox" class="sr-only peer">
          <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:bg-red-500 transition-colors"></div>
          <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>

    <!-- Bypass Charging -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm" data-i18n="bypass_charging">Bypass Charging</label>
      <div class="flex justify-between items-center bg-zinc-800 px-4 py-3 rounded-xl shadow">
        <div class="flex items-center space-x-2">
          <img src="assets/charging.svg" alt="Bypass" class="w-5 h-5" />
          <span id="charging-status">Disabled</span>
        </div>
        <!-- Toggle Switch -->
        <label class="relative inline-flex items-center cursor-pointer">
          <input id="charging-toggle" type="checkbox" class="sr-only peer">
          <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:bg-red-500 transition-colors"></div>
          <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transform peer-checked:translate-x-5 transition-transform"></div>
        </label>
      </div>
    </div>

    <!-- Game List for Bypass Charging -->
    <div class="px-6 mt-6">
      <label class="block mb-2 font-semibold text-sm" data-i18n="game_bypass">Auto Bypass for Games</label>
      <div class="bg-zinc-800 rounded-xl p-4 shadow">
        <div class="flex justify-between items-center mb-3">
          <span data-i18n="game_list">Game Package List</span>
          <div class="flex space-x-2">
            <button id="add-game" class="bg-gray-500 text-white px-2 py-1 rounded-lg text-sm flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
              </svg>
            </button>
            <button id="edit-gamelist" class="bg-red-500 text-white px-4 py-1 rounded-lg text-sm">
              <span data-i18n="edit">Edit</span>
            </button>
          </div>
        </div>
        <div class="bg-zinc-700 rounded-lg p-3 h-32 overflow-y-auto text-xs" id="gamelist-preview">
          Loading game list...
        </div>
        <div class="mt-3 text-xs text-gray-400" data-i18n="game_list_help">
          Bypass charging will auto-enable when these games are detected
        </div>
      </div>
    </div>
    
    <!-- Add Game Modal -->
    <div id="addgame-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-zinc-800 rounded-xl w-full max-w-md max-h-[80vh] flex flex-col">
        <div class="p-4 border-b border-zinc-700">
          <h3 class="font-bold" data-i18n="add_game">Add Game Package</h3>
        </div>
        <div class="p-4 flex-1">
          <input type="text" id="game-package-input" class="w-full bg-zinc-700 text-white p-3 rounded-lg" 
                 placeholder="com.example.game" autocomplete="off">
          <div class="mt-3 text-xs text-gray-400" data-i18n="package_help">
            Enter the game's package name (e.g. com.mobile.legends)
          </div>
        </div>
        <div class="p-4 border-t border-zinc-700 flex justify-end space-x-3">
          <button id="cancel-addgame" class="px-4 py-2 rounded-lg bg-zinc-700" data-i18n="cancel">Cancel</button>
          <button id="confirm-addgame" class="px-4 py-2 rounded-lg bg-gray-500" data-i18n="add">Add</button>
        </div>
      </div>
    </div>

    <!-- Game List Editor Modal -->
    <div id="gamelist-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-zinc-800 rounded-xl w-full max-w-md max-h-[80vh] flex flex-col">
        <div class="p-4 border-b border-zinc-700">
          <h3 class="font-bold" data-i18n="edit_game_list">Edit Game List</h3>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
          <textarea id="gamelist-edit" class="w-full h-64 bg-zinc-700 text-white p-3 rounded-lg text-xs font-mono"></textarea>
        </div>
        <div class="p-4 border-t border-zinc-700 flex justify-end space-x-3">
          <button id="cancel-gamelist" class="px-4 py-2 rounded-lg bg-zinc-700" data-i18n="cancel">Cancel</button>
          <button id="save-gamelist" class="px-4 py-2 rounded-lg bg-red-500" data-i18n="save">Save</button>
        </div>
      </div>
    </div>

    <!-- About Modules -->
    <div class="px-6 mt-6 mb-8">
      <label class="block mb-2 font-semibold text-sm" data-i18n="about_modules">About Modules</label>
      <div class="bg-zinc-800 rounded-xl px-4 py-3 flex items-center justify-between shadow">
        <div class="text-sm">
          <p>
            <span data-i18n="author">Author</span><br>
            <span id="module-status" class="text-gray-400">belowzeroiq</span></p>

          <p>
            <span data-i18n="github_project">GitHub Project</span><br>
            <span class="text-gray-400">TNF Tweaker</span>
          </p>
          <p>
            <span data-i18n="support_group">Support group</span><br>
            <span class="text-gray-400">t.me/topnotchfreaks_chat</span>
          </p>
        </div>
        <div class="flex flex-col space-y-3 items-end ml-4">
          <a href="https://github.com/belowzeroiq" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors" title="GitHub">
            <img src="assets/github.svg" alt="Author" class="w-6 h-6 inline" style="filter: invert(1) brightness(2);" />
          </a>
          <a href="https://github.com/topnotchfreaks/tnf_tweaker" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors" title="GitHub">
            <img src="assets/github.svg" alt="Author" class="w-6 h-6 inline" style="filter: invert(1) brightness(2);" />
          </a>
          <a href="https://t.me/topnotchfreaks_chat" target="_blank" rel="noopener noreferrer" class="hover:text-white transition-colors" title="Telegram">
            <img src="assets/telegram.svg" alt="Telegram" class="w-6 h-6 inline" style="filter: invert(1) brightness(2);" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-50 bg-zinc-800 text-white px-6 py-3 rounded-xl shadow-lg opacity-0 pointer-events-none transition-all duration-300"></div>

  <script>
    // filepath: /home/env/Documents/GitHub/tnf_tweaker/webroot/index.html
    // --- KernelSU JS API helpers ---
    let callbackCounter = 0;
    function getUniqueCallbackName(prefix) {
      return `${prefix}_callback_${Date.now()}_${callbackCounter++}`;
    }

    function exec(command, options) {
      if (typeof options === "undefined") options = {};
      return new Promise((resolve, reject) => {
        const callbackFuncName = getUniqueCallbackName("exec");
        window[callbackFuncName] = (errno, stdout, stderr) => {
          resolve({ errno, stdout, stderr });
          delete window[callbackFuncName];
        };
        try {
          ksu.exec(command, JSON.stringify(options), callbackFuncName);
        } catch (error) {
          reject(error);
          delete window[callbackFuncName];
        }
      });
    }

    async function updateTweakerConfig(key, value) {
    const path = "/data/adb/tnftweaker/tweaker_config.conf";

      try {
        const { stdout } = await exec(`cat ${path} || touch ${path} && echo ""`);
        const lines = stdout.split("\n").filter(Boolean);
        let updated = false;
      
        // Update line if key exists
        const newLines = lines.map(line => {
          if (line.startsWith(`${key}=`)) {
            updated = true;
            return `${key}=${value}`;
          }
          return line;
        });
      
        if (!updated) {
          newLines.push(`${key}=${value}`);
        }
      
        const newContent = newLines.join("\n");
      
        await exec(`echo "${newContent}" > ${path}`);
      } catch (err) {
        console.error("Failed to update tweaker_config.conf:", err);
      }
    }

    // Function to load the current kernel profile
    const profileSelect = document.getElementById('profileSelect');
    const profileIcon = document.getElementById('profileIcon');
    const icons = {
      powersave: 'icons/powersave.png',
      balanced: 'icons/balanced.png',
      performance: 'icons/performance.png',
    };

    async function loadCurrentProfile() {
      try {
        const { stdout } = await exec('cat /sys/kernel/kprofiles/kp_mode');
        const val = stdout.trim();
        const map = { '1': 'powersave', '2': 'balanced', '3': 'performance' };
        const profile = map[val] || 'balanced';
        profileSelect.value = profile;
        profileIcon.src = icons[profile];
      } catch (err) {
        console.error("Failed to read kernel profile:", err);
      }
    }

    // Function to set kernel profile mode
    function setKProfilesMode(mode) {
      // Map mode string to value
      let value = "3"; // Default to Performance
      if (mode === "powersave") value = "1";
      else if (mode === "balanced") value = "2";
      else if (mode === "performance") value = "3";
      // Execute the shell command
      return exec(`echo ${value} > /sys/kernel/kprofiles/kp_mode`);
    }

    // --- UI logic ---
    document.addEventListener('DOMContentLoaded', async () => {
      fetchDeviceInfo(); // Start fetching device info immediately

      await loadTweakerConfig();

      // Profile icon logic
      const profileSelect = document.getElementById('profile-select');
      const profileIcon = document.getElementById('profile-icon');
      const applyProfileBtn = document.getElementById('apply-profile');
      const icons = {
        powersave: 'assets/powersave.svg',
        balanced: 'assets/balanced.svg',
        performance: 'assets/performance.svg'
      };

      if (applyProfileBtn && profileSelect) {
        applyProfileBtn.addEventListener('click', () => {
          const selectedText = profileSelect.options[profileSelect.selectedIndex].text;
          setKProfilesMode(profileSelect.value)
            .then(() => {
              showToast(`Applied profile: ${selectedText}`);
              // Save the selected profile persistently for boot
              exec(`echo "profile=${profileSelect.value}" > /data/adb/tnftweaker/tweaker_config.conf`);
            })
            .catch(() => showToast('Failed to apply profile'));
        });
      }

      // Remove this block to prevent auto-applying on select change:
      if (profileSelect && profileIcon) {
        profileSelect.addEventListener('change', (e) => {
          profileIcon.src = icons[e.target.value] || icons.balanced;
          showToast(`Profile set to ${e.target.options[e.target.selectedIndex].text}`);
        });
        profileIcon.src = icons[profileSelect.value] || icons.balanced;
      }

      // Toast for toggles
      document.querySelectorAll('input[type="checkbox"]').forEach(toggle => {
        // Skip bypass toggle and thermal toggle (handled separately)
        if (toggle.id === 'bypass-toggle' || toggle.id === 'thermal-toggle') return;
        toggle.addEventListener('change', (e) => {
          const label = e.target.closest('.flex.items-center.space-x-2')?.innerText ||
                        e.target.closest('.flex.items-center')?.innerText ||
                        'Setting';
          showToast(`${label.trim()} ${e.target.checked ? 'enabled' : 'disabled'}`);
        });
        // Skip bypass toggle and charging toggle (handled separately)
        if (toggle.id === 'bypass-toggle' || toggle.id === 'charging-toggle') return;
        toggle.addEventListener('change', (e) => {
          const label = e.target.closest('.flex.items-center.space-x-2')?.innerText ||
                        e.target.closest('.flex.items-center')?.innerText ||
                        'Setting';
          showToast(`${label.trim()} ${e.target.checked ? 'enabled' : 'disabled'}`);
        });
      });

      // Refresh button notification
      const refreshBtn = document.getElementById('refresh-btn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          showToast('Refreshed!');
          fetchDeviceInfo();
          fetchModuleVersion();
        });
      }

    // Load current profile on page load
    document.addEventListener("DOMContentLoaded", () => {
      profileSelect.addEventListener("change", async () => {
        const selected = profileSelect.value;
        await setKProfilesMode(selected);
        await updateTweakerConfig("profile", selected);
      });
    
      loadCurrentProfile(); // This alone is enough
    });

      // Thermal toggle logic
      const thermalToggle = document.getElementById('thermal-toggle');
      const thermalStatus = document.getElementById('thermal-status');
        
      if (thermalToggle && thermalStatus) {
        thermalToggle.addEventListener('change', async (e) => {
          const enabled = e.target.checked;
          const result = await setThermalThrottling(enabled);
        
          thermalStatus.textContent = result ? (enabled ? 'Enabled' : 'Disabled') : 'Failed';
          showToast('Reboot to apply thermal change');
        
          await updateTweakerConfig("thermal", enabled ? "enabled" : "disabled");
        });
      }

      // Bypass Charging toggle logic
      const chargingToggle = document.getElementById('charging-toggle');
      const chargingStatus = document.getElementById('charging-status');
        
      if (chargingToggle && chargingStatus) {
        chargingToggle.addEventListener('change', async (e) => {
          const enabled = e.target.checked;
          const result = await setBypassCharging(enabled);
        
          chargingStatus.textContent = result ? (enabled ? 'Enabled' : 'Disabled') : 'Failed';
          showToast(`Bypass charging ${result ? (enabled ? 'enabled' : 'disabled') : 'failed'}`);
        
        });
      }

      // Initial fetches
      fetchDeviceInfo();
      fetchModuleVersion();
    });

    // Toast notification function
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('opacity-0', 'pointer-events-none');
      toast.classList.add('opacity-100');
      clearTimeout(window._toastTimeout);
      window._toastTimeout = setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0', 'pointer-events-none');
      }, 2000);
    }

    // Fetch kernel version and device model using KernelSU exec
    function fetchDeviceInfo() {
      // Start both fetches at the same time
      exec('uname -r').then(({ stdout }) => {
        document.getElementById('kernel-version').textContent = stdout.trim() || 'Unknown';
      }).catch(() => {
        document.getElementById('kernel-version').textContent = 'Error loading';
      });

      exec('getprop ro.product.vendor.model').then(({ stdout }) => {
        document.getElementById('device-model').textContent = stdout.trim() || 'Unknown';
      }).catch(() => {
        document.getElementById('device-model').textContent = 'Error loading';
      });
    }

    // Fetch module version from GitHub releases (still uses fetch, not exec)
    function fetchModuleVersion() {
      fetch('https://api.github.com/repos/topnotchfreaks/tnf_tweaker/releases/latest')
        .then(res => res.json())
        .then (data => {
          document.getElementById('module-version').textContent = data.tag_name || 'Unknown';
        })
        .catch(() => {
          document.getElementById('module-version').textContent = 'Unavailable';
        });
    }

// Function to the thermal throttling
async function setThermalThrottling(enable) {
  try {
    let commands = [];
    if (enable) {
      commands = [
        `sh /data/adb/modules/tnftweaker/scripts/enable_thermal.sh`,
      ];
    } else {
      commands = [
        `sh /data/adb/modules/tnftweaker/scripts/disable_thermal.sh`
      ];
    }
    for (const cmd of commands) {
      await exec(cmd);
    }
    return true;
  } catch {
    return false;
  }
}

    // Set bypass charging state using KernelSU exec
    async function setBypassCharging(enable) {
      try {
        let commands = [];
        if (enable) {
          commands = [
            `echo 1 > /sys/class/qcom-battery/input_suspend`
          ];
        } else {
          commands = [
            `echo 0 > /sys/class/qcom-battery/input_suspend`
          ];
        }
        for (const cmd of commands) {
          await exec(cmd);
        }
        return true;
      } catch {
        return false;
      }
    }

    async function loadTweakerConfig() {
      const path = "/data/adb/tnftweaker/tweaker_config.conf";
      try {
        const { stdout } = await exec(`cat ${path} || echo ""`);
        const lines = stdout.split("\n").filter(Boolean);
        let profile = "balanced";
        let thermal = "enabled";

        lines.forEach(line => {
          if (line.startsWith("profile=")) profile = line.split("=")[1];
          if (line.startsWith("thermal=")) thermal = line.split("=")[1];
          // bypasscharging= is ignored
        });

        // Set kernel profile select and icon
        const profileSelect = document.getElementById('profile-select');
        const profileIcon = document.getElementById('profile-icon');
        if (profileSelect) {
          profileSelect.value = profile;
          if (profileIcon) {
            const icons = {
              powersave: 'assets/powersave.svg',
              balanced: 'assets/balanced.svg',
              performance: 'assets/performance.svg'
            };
            profileIcon.src = icons[profile] || icons.balanced;
          }
          // Apply the profile to the system
          await setKProfilesMode(profile);
        }

        // Set thermal toggle and status
        const thermalToggle = document.getElementById('thermal-toggle');
        const thermalStatus = document.getElementById('thermal-status');
        if (thermalToggle && thermalStatus) {
          thermalToggle.checked = (thermal === "enabled");
          await setThermalThrottling(thermal === "enabled");
          thermalStatus.textContent = (thermal === "enabled") ? "Enabled" : "Disabled";
        }

        // Set bypass charging toggle and status
        const chargingToggle = document.getElementById('charging-toggle');
        const chargingStatus = document.getElementById('charging-status');
        if (chargingToggle && chargingStatus) {
          chargingToggle.checked = (bypasscharging === "enabled");
          await setBypassCharging(bypasscharging === "enabled");
          chargingStatus.textContent = (bypasscharging === "enabled") ? "Enabled" : "Disabled";
        }
      } catch (err) {
        console.error("Failed to load tweaker_config.conf:", err);
      }
    }

    loadTweakerConfig();
  </script>
  <script>
const translations = {
  en: {
    kernel_profiles_mode: "Kernel Profiles Mode",
    cpu_governor: "CPU Governor",
    thermal_throttling: "Thermal Throttling",
    bypass_charging: "Bypass Charging",
    about_modules: "About Modules",
    kernel_version: "Kernel version",
    device_model: "Device model",
    module_version: "Module version",
    author: "Author",
    github_project: "GitHub Project",
    support_group: "Support group",
    game_bypass: "Auto Bypass for Games",
    game_list: "Game Package List",
    edit: "Edit",
    game_list_help: "Bypass charging will auto-enable when these games are detected",
    edit_game_list: "Edit Game List",
    cancel: "Cancel",
    save: "Save",
    add_game: "Add Game Package",
    package_help: "Enter the game's package name (e.g. com.mobile.legends)",
    add: "Add"
  },
  es: {
    kernel_profiles_mode: "Modo de Perfiles del Kernel",
    cpu_governor: "Gobernador de CPU",
    thermal_throttling: "Limitación Térmica",
    bypass_charging: "Omitir Carga",
    about_modules: "Acerca de los Módulos",
    kernel_version: "Versión del kernel",
    device_model: "Modelo del dispositivo",
    module_version: "Versión del módulo",
    author: "Autor",
    github_project: "Proyecto GitHub",
    support_group: "Grupo de soporte",
    game_bypass: "Bypass automático para juegos",
    game_list: "Lista de paquetes de juegos",
    edit: "Editar",
    game_list_help: "El bypass de carga se activará automáticamente cuando se detecten estos juegos",
    edit_game_list: "Editar lista de juegos",
    cancel: "Cancelar",
    save: "Guardar",
    add_game: "Agregar Paquete de Juego",
    package_help: "Ingrese el nombre del paquete del juego (ej. com.mobile.legends)",
    add: "Agregar"
  },
  id: {
    kernel_profiles_mode: "Mode Profil Kernel",
    cpu_governor: "Governor CPU",
    thermal_throttling: "Pembatasan Termal",
    bypass_charging: "Lewati Pengisian",
    about_modules: "Tentang Modul",
    kernel_version: "Versi kernel",
    device_model: "Model perangkat",
    module_version: "Versi modul",
    author: "Penulis",
    github_project: "Proyek GitHub",
    support_group: "Grup dukungan",
    game_bypass: "Auto Bypass untuk Game",
    game_list: "Daftar Paket Game",
    edit: "Edit",
    game_list_help: "Bypass charging akan aktif otomatis saat game ini terdeteksi",
    edit_game_list: "Edit Daftar Game",
    cancel: "Batal",
    save: "Simpan",
    add_game: "Tambah Paket Game",
    package_help: "Masukkan nama paket game (misal: com.mobile.legends)",
    add: "Tambah"
  },
  ja: {
    kernel_profiles_mode: "カーネルプロファイルモード",
    cpu_governor: "CPUガバナー",
    thermal_throttling: "サーマルスロットリング",
    bypass_charging: "バイパス充電",
    about_modules: "モジュールについて",
    kernel_version: "カーネルバージョン",
    device_model: "デバイスモデル",
    module_version: "モジュールバージョン",
    author: "作者",
    github_project: "GitHubプロジェクト",
    support_group: "サポートグループ",
    game_bypass: "ゲーム自動バイパス",
    game_list: "ゲームパッケージ一覧",
    edit: "編集",
    game_list_help: "これらのゲームが検出されたら自動的にバイパス充電を有効化します",
    edit_game_list: "ゲームリストを編集",
    cancel: "キャンセル",
    save: "保存",
    add_game: "ゲームパッケージを追加",
    package_help: "ゲームのパッケージ名を入力 (例: com.mobile.legends)",
    add: "追加"
  },
  pt: {
    kernel_profiles_mode: "Modo de Perfis do Kernel",
    cpu_governor: "Governador da CPU",
    thermal_throttling: "Limitação Térmica",
    bypass_charging: "Ignorar Carregamento",
    about_modules: "Sobre os Módulos",
    kernel_version: "Versão do kernel",
    device_model: "Modelo do dispositivo",
    module_version: "Versão do módulo",
    author: "Autor",
    github_project: "Projeto no GitHub",
    support_group: "Grupo de suporte",
    game_bypass: "Bypass automático para jogos",
    game_list: "Lista de pacotes de jogos",
    edit: "Editar",
    game_list_help: "O bypass será ativado automaticamente ao detectar esses jogos",
    edit_game_list: "Editar lista de jogos",
    cancel: "Cancelar",
    save: "Salvar",
    add_game: "Adicionar pacote de jogo",
    package_help: "Digite o nome do pacote do jogo (ex: com.mobile.legends)",
    add: "Adicionar"
  },
  zh: {
    kernel_profiles_mode: "内核配置模式",
    cpu_governor: "CPU 调速器",
    thermal_throttling: "温控降频",
    bypass_charging: "旁路充电",
    about_modules: "关于模块",
    kernel_version: "内核版本",
    device_model: "设备型号",
    module_version: "模块版本",
    author: "作者",
    github_project: "GitHub 项目",
    support_group: "支持群组",
    game_bypass: "游戏自动旁路",
    game_list: "游戏包列表",
    edit: "编辑",
    game_list_help: "检测到以下游戏时将自动启用旁路充电",
    edit_game_list: "编辑游戏列表",
    cancel: "取消",
    save: "保存",
    add_game: "添加游戏包",
    package_help: "输入游戏的包名 (例如: com.mobile.legends)",
    add: "添加"
  },
  kr: {
    kernel_profiles_mode: "커널 프로필 모드",
    cpu_governor: "CPU 거버너",
    thermal_throttling: "열 스로틀링",
    bypass_charging: "바이패스 충전",
    about_modules: "모듈 정보",
    kernel_version: "커널 버전",
    device_model: "디바이스 모델",
    module_version: "모듈 버전",
    author: "작성자",
    github_project: "GitHub 프로젝트",
    support_group: "지원 그룹",
    game_bypass: "게임 자동 바이패스",
    game_list: "게임 패키지 목록",
    edit: "편집",
    game_list_help: "다음 게임이 감지되면 자동으로 바이패스 충전이 활성화됩니다",
    edit_game_list: "게임 목록 편집",
    cancel: "취소",
    save: "저장",
    add_game: "게임 패키지 추가",
    package_help: "게임의 패키지 이름 입력 (예: com.mobile.legends)",
    add: "추가"
  }
};

function updateLanguage(lang) {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang] && translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });
}

document.addEventListener('DOMContentLoaded', async () => {
  const langSelect = document.getElementById('lang-select');
  langSelect.addEventListener('change', (e) => {
    updateLanguage(e.target.value);
    localStorage.setItem('tnf_lang', e.target.value);
  });

  // Set initial language
  const savedLang = localStorage.getItem('tnf_lang') || 'en';
  langSelect.value = savedLang;
  updateLanguage(savedLang);
});

document.addEventListener('DOMContentLoaded', () => {
  updateDeviceStats();
  setInterval(updateDeviceStats, 3000); // Refresh every 3 seconds
});

async function updateDeviceStats() {
  try {
    // 1. CPU Big Frequency (assumed from policy4 – adjust if necessary)
    const { stdout: cpuBigRaw } = await exec("cat /sys/devices/system/cpu/cpufreq/policy4/scaling_cur_freq");
    const cpuBigMHz = Math.round(parseInt(cpuBigRaw.trim()) / 1000);
    document.getElementById('cpu-big-clock').textContent = `${cpuBigMHz} MHz`;

    // 2. CPU Little Frequency (assumed from policy4 – adjust if necessary)
    const { stdout: cpuFreqRaw } = await exec("cat /sys/devices/system/cpu/cpufreq/policy0/scaling_cur_freq");
    const cpuMHz = Math.round(parseInt(cpuFreqRaw.trim()) / 1000);
    document.getElementById('cpu-little-clock').textContent = `${cpuMHz} MHz`;

    // Battery Temperature (°C)
    const { stdout: battTempRaw } = await exec("cat /sys/class/power_supply/battery/temp");
    const battTempC = (parseInt(battTempRaw.trim()) / 10).toFixed(1);
    document.getElementById('battery-temp').textContent = `${battTempC} °C`;

    // RAM Utilization (%)
    const { stdout: memInfoRaw } = await exec("cat /proc/meminfo");
    const memInfo = parseMemInfo(memInfoRaw);
    const ramUsedPercent = Math.round(((memInfo.MemTotal - memInfo.MemAvailable) / memInfo.MemTotal) * 100);
    document.getElementById('ram-util').textContent = `${ramUsedPercent} %`;

  } catch (err) {
    console.error('Error updating device stats:', err);
  }
}

// Parse /proc/meminfo into object { MemTotal: bytes, MemAvailable: bytes, ... }
function parseMemInfo(raw) {
  return raw.split('\n').reduce((acc, line) => {
    const [key, val] = line.split(':');
    if (!key || !val) return acc;
    acc[key.trim()] = parseInt(val.trim().split(' ')[0]) * 1024; // from kB to bytes
    return acc;
  }, {});
}

document.addEventListener('DOMContentLoaded', async () => {
    await loadAvailableGovernors(); // Load governors on page load
});

// Load available governors
async function loadAvailableGovernors() {
  try {
    const { stdout } = await exec("cat /sys/devices/system/cpu/cpufreq/policy0/scaling_available_governors");
    const governors = stdout.trim().split(/\s+/);
    const select = document.getElementById("governor-select");

    select.innerHTML = ""; // Clear options
    governors.forEach(gov => {
      const option = document.createElement("option");
      option.value = gov;
      option.textContent = gov.charAt(0).toUpperCase() + gov.slice(1);
      select.appendChild(option);
    });

    // Set current governor
    const { stdout: current } = await exec("cat /sys/devices/system/cpu/cpufreq/policy0/scaling_governor");
    select.value = current.trim();
  } catch (err) {
    console.error("Governor loading error:", err);
    showToast("Failed to load governors");
  }
}

// Apply governor on button click
document.getElementById("apply-governor").addEventListener("click", async () => {
  const selectedGovernor = document.getElementById("governor-select").value;
  if (!selectedGovernor) return showToast("Select a governor first");

  try {
    const { stdout } = await exec("ls /sys/devices/system/cpu/cpufreq | grep policy");
    const policies = stdout.trim().split("\n");

    for (const policy of policies) {
      await exec(`echo ${selectedGovernor} > /sys/devices/system/cpu/cpufreq/${policy}/scaling_governor`);
    }

    showToast(`Governor set to ${selectedGovernor}`);
    await updateTweakerConfig("governor", selectedGovernor);
  } catch (err) {
    console.error("Governor apply error:", err);
    showToast("Failed to apply governor");
  }
});

document.addEventListener('DOMContentLoaded', async () => {
    // Add Game Button
    document.getElementById('add-game').addEventListener('click', showAddGameModal);

    // Edit Game List Button
    document.getElementById('edit-gamelist').addEventListener('click', () => {
        document.getElementById('gamelist-modal').classList.remove('hidden');
    });

    // Cancel Add Game Button
    document.getElementById('cancel-addgame').addEventListener('click', () => {
        document.getElementById('addgame-modal').classList.add('hidden');
    });

    // Cancel Edit Game List Button
    document.getElementById('cancel-gamelist').addEventListener('click', () => {
        document.getElementById('gamelist-modal').classList.add('hidden');
    });

    // Confirm Add Game Button
    document.getElementById('confirm-addgame').addEventListener('click', addGamePackage);

    // Save Game List Button
    document.getElementById('save-gamelist').addEventListener('click', saveGameList);

    await loadGameList(); // Load the game list on page load
});

// Function to show Add Game Modal
function showAddGameModal() {
    document.getElementById('addgame-modal').classList.remove('hidden');
    document.getElementById('game-package-input').focus(); // Focus on the input field
}

// Function to add a game package
async function addGamePackage() {
    const packageName = document.getElementById('game-package-input').value.trim();

    if (!packageName) {
        showToast('Please enter a package name');
        return;
    }

    try {
        // Check if package already exists
        const { stdout } = await exec('cat /data/adb/tnftweaker/gamelist.txt || echo ""');
        const games = stdout.trim().split('\n').filter(Boolean);

        if (games.includes(packageName)) {
            showToast('This game is already in the list');
            return;
        }

        // Add the new package
        await exec(`echo "${packageName}" >> /data/adb/tnftweaker/gamelist.txt`);
        document.getElementById('game-package-input').value = ''; // Clear input
        document.getElementById('addgame-modal').classList.add('hidden'); // Hide modal
        loadGameList(); // Reload the game list
        showToast('Game added successfully');
    } catch (err) {
        console.error("Failed to add game:", err);
        showToast('Failed to add game');
    }
}

// Function to save the game list
async function saveGameList() {
    const content = document.getElementById('gamelist-edit').value.trim();
    try {
        await exec(`echo "${content}" > /data/adb/tnftweaker/gamelist.txt`);
        loadGameList(); // Reload the game list
        showToast('Game list saved');
        document.getElementById('gamelist-modal').classList.add('hidden'); // Hide modal
    } catch (err) {
        console.error("Failed to save game list:", err);
        showToast('Failed to save game list');
    }
}

// Function to show toast notifications
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.remove('opacity-0', 'pointer-events-none');
    toast.classList.add('opacity-100');
    clearTimeout(window._toastTimeout);
    window._toastTimeout = setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0', 'pointer-events-none');
    }, 2000);
}

// Function to load the game list
async function loadGameList() {
    try {
        // Read the game list from the file
        const { stdout } = await exec('cat /data/adb/tnftweaker/gamelist.txt || echo ""');
        const games = stdout.trim().split('\n').filter(Boolean); // Split by new lines and filter out empty lines

        // Update the game list preview area
        const gamelistPreview = document.getElementById('gamelist-preview');
        if (games.length > 0) {
            gamelistPreview.textContent = games.join('\n'); // Join games with new lines for display
        } else {
            gamelistPreview.textContent = 'No games in list'; // Display message if no games
        }

        // Update the textarea in the edit modal
        const gamelistEdit = document.getElementById('gamelist-edit');
        gamelistEdit.value = games.join('\n'); // Set the textarea value to the game list
    } catch (err) {
        console.error("Failed to load game list:", err);
        showToast('Failed to load game list');
    }
}

  </script>
</body>
</html>
